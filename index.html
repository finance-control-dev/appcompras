<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Lista de Compras Premium</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <!-- PWA Manifest & Meta -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1E293B">
  <link rel="apple-touch-icon" href="icon-192.png">
  <!-- Firebase SDKs (v10 compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <style>
    /* --- RESET & BASE --- */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent
    }

    :root {
      --font: 'Inter', sans-serif;
      --safe-bottom: env(safe-area-inset-bottom, 20px);

      /* Default Dark Mode Colors */
      --text-primary: #F8FAFC;
      --text-secondary: rgba(255, 255, 255, 0.6);
      --glass-bg: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.08);
      --input-bg: rgba(30, 41, 59, 0.8);
      --item-bg: rgba(255, 255, 255, 0.02);
      --drawer-bg: #1E293B;
      --icon-highlight: rgba(255, 255, 255, 0.1);
    }

    /* Light Mode Overrides */
    body.light-mode {
      background: var(--bg-grad-light);
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --glass-bg: rgba(255, 255, 255, 0.65);
      --glass-border: rgba(255, 255, 255, 0.4);
      --input-bg: rgba(255, 255, 255, 0.9);
      --item-bg: rgba(255, 255, 255, 0.5);
      --drawer-bg: #ffffff;
      --icon-highlight: rgba(0, 0, 0, 0.05);
      color: var(--text-primary);
    }

    /* --- THEMES (CSS Variables) --- */
    /* Default: Midnight Slate */
    [data-theme="slate"] {
      --bg-grad: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
      --bg-grad-light: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      --accent: #F97316;
      --accent-glow: rgba(249, 115, 22, 0.4);
    }

    [data-theme="ocean"] {
      --bg-grad: linear-gradient(135deg, #0f1c3f 0%, #1e3a8a 100%);
      --bg-grad-light: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      --accent: #38bdf8;
      --accent-glow: rgba(56, 189, 248, 0.4);
    }

    [data-theme="forest"] {
      --bg-grad: linear-gradient(135deg, #052e16 0%, #14532d 100%);
      --bg-grad-light: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      --accent: #4ade80;
      --accent-glow: rgba(74, 222, 128, 0.4);
    }

    [data-theme="burgundy"] {
      --bg-grad: linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%);
      --bg-grad-light: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
      --accent: #fb7185;
      --accent-glow: rgba(251, 113, 133, 0.4);
    }

    [data-theme="purple"] {
      --bg-grad: linear-gradient(135deg, #2e1065 0%, #581c87 100%);
      --bg-grad-light: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
      --accent: #c084fc;
      --accent-glow: rgba(192, 132, 252, 0.4);
    }

    [data-theme="gold"] {
      --bg-grad: linear-gradient(135deg, #272005 0%, #422006 100%);
      --bg-grad-light: linear-gradient(135deg, #fef9c3 0%, #fde047 100%);
      --accent: #fbbf24;
      --accent-glow: rgba(251, 191, 36, 0.4);
    }

    [data-theme="pink"] {
      --bg-grad: linear-gradient(135deg, #831843 0%, #be185d 100%);
      --bg-grad-light: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
      --accent: #f472b6;
      --accent-glow: rgba(244, 114, 182, 0.4);
    }

    [data-theme="charcoal"] {
      --bg-grad: linear-gradient(135deg, #18181b 0%, #27272a 100%);
      --bg-grad-light: linear-gradient(135deg, #f4f4f5 0%, #e4e4e7 100%);
      --accent: #9ca3af;
      --accent-glow: rgba(156, 163, 175, 0.4);
    }

    [data-theme="sunset"] {
      --bg-grad: linear-gradient(135deg, #4c0519 0%, #9f1239 100%);
      --bg-grad-light: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);
      --accent: #fb923c;
      --accent-glow: rgba(251, 146, 60, 0.4);
    }

    [data-theme="navy"] {
      --bg-grad: linear-gradient(135deg, #172554 0%, #1e3a8a 100%);
      --bg-grad-light: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      --accent: #60a5fa;
      --accent-glow: rgba(96, 165, 250, 0.4);
    }

    body {
      font-family: var(--font);
      background: var(--bg-grad);
      color: var(--text-primary);
      height: 100vh;
      /* Fixed height for scroll */
      display: flex;
      flex-direction: column;
      overflow: hidden;
      /* App-like feel */
      transition: background 0.5s ease;
    }

    /* --- GLASSMORPHISM UTILITIES --- */
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .glass-panel {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* --- LAYOUT --- */
    .app-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }

    .header-title-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #FFD700, #F97316);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      font-size: 20px;
    }

    .app-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 140px;
      /* Space for input bar */
    }

    /* --- LISTS --- */
    .list-card {
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      transition: transform 0.2s, background 0.2s;
      position: relative;
      overflow: hidden;
    }

    .list-card:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.07);
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .list-name {
      font-weight: 600;
      font-size: 16px;
      width: 100%;
      outline: none;
      background: transparent;
      border: none;
      color: var(--text-primary);
    }

    .list-meta {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      gap: 10px;
    }

    .progress-mini {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }

    .progress-bar-mini {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.5s;
    }

    /* --- ITEMS --- */
    .item-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      background: var(--item-bg);
      border: 1px solid var(--glass-border);
      transition: all 0.2s;
      animation: slideIn 0.3s ease;
    }

    .item-check {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      cursor: pointer;
    }

    .item-row.checked .item-check {
      background: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 0 10px var(--accent-glow);
    }

    .item-row.checked .item-content {
      opacity: 0.5;
      text-decoration: line-through;
    }

    .item-content {
      flex: 1;
      min-width: 0;
      cursor: pointer;
      /* Clickable */
    }

    .item-name {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .item-details {
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      gap: 6px;
    }

    .category-tag {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .price-tag {
      color: var(--accent);
      font-weight: 600;
    }

    .item-actions {
      display: flex;
      gap: 8px;
      /* opacity: 0; removed for mobile/better UX */
      /* transition: opacity 0.2s; */
    }

    /*
    .item-row:hover .item-actions {
      opacity: 1;
    }
    */

    .user-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--icon-highlight);
      border: 1px solid var(--glass-border);
      overflow: hidden;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .user-btn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-status {
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      position: absolute;
      bottom: 0;
      right: 0;
      border: 1px solid var(--drawer-bg);
    }

    .user-btn.online .user-status {
      background: #10b981;
    }

    .action-btn {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: var(--icon-highlight);
      border: none;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      /* Prevent shrinking on mobile */
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .action-btn.del {
      background: rgba(239, 68, 68, 0.1);
      /* Subtle red background */
      color: #ef4444;
      /* Explicit red text */
    }

    .action-btn.del:hover {
      background: #ef4444;
      color: white;
    }

    body.light-mode .action-btn.del {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    body.light-mode .action-btn.del:hover {
      background: #dc2626;
      color: white;
    }

    /* --- BOTTOM BAR --- */
    .bottom-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px;
      padding-bottom: max(16px, var(--safe-bottom));
      z-index: 20;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--input-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      padding: 8px;
      border-radius: 24px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .smart-input {
      flex: 1;
      width: 0;
      /* Fix flex overflow */
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 16px;
      padding: 0 12px;
      height: 44px;
    }

    .add-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--accent);
      color: #0F172A;
      border: none;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px var(--accent-glow);
      transition: transform 0.2s;
      cursor: pointer;
      flex-shrink: 0;
      /* Prevent shrinking on mobile */
    }

    .add-btn:active {
      transform: scale(0.9);
    }

    /* --- THEME DRAWER --- */
    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 40;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .drawer-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .theme-drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--drawer-bg);
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      padding: 24px;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 50;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .theme-drawer.active {
      transform: translateY(0);
    }

    .theme-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .theme-opt {
      aspect-ratio: 1;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .theme-opt.active {
      border-color: white;
      transform: scale(1.1);
    }

    /* --- TOTALS --- */
    .budget-chip {
      position: absolute;
      bottom: 80px;
      right: 20px;
      background: var(--accent);
      color: #0F172A;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 4px 12px var(--accent-glow);
      pointer-events: none;
      animation: popIn 0.3s;
      animation: popIn 0.3s;
    }

    /* --- LOGIN SCREEN --- */
    .login-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease, visibility 0.5s;
    }

    /* Floating blobs animation */
    .login-bg-blob {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.4;
      animation: float 10s infinite ease-in-out;
    }

    .blob-1 {
      width: 300px;
      height: 300px;
      background: var(--primary);
      top: -10%;
      left: -10%;
      animation-delay: 0s;
    }

    .blob-2 {
      width: 250px;
      height: 250px;
      background: var(--accent);
      bottom: -10%;
      right: -10%;
      animation-delay: -5s;
    }

    @keyframes float {

      0%,
      100% {
        transform: translate(0, 0);
      }

      50% {
        transform: translate(30px, 50px);
      }
    }

    .login-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    body.light-mode .login-screen {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }

    .login-content {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      padding: 48px;
      border-radius: 32px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      text-align: center;
      box-shadow: 0 32px 64px rgba(0, 0, 0, 0.4);
      max-width: 90%;
      width: 380px;
      position: relative;
      overflow: hidden;
      z-index: 10;
    }

    /* Active border gradient */
    .login-content::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 32px;
      padding: 1.5px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    body.light-mode .login-content {
      background: rgba(255, 255, 255, 0.65);
      border-color: rgba(255, 255, 255, 0.6);
      box-shadow: 0 32px 64px rgba(0, 0, 0, 0.1);
    }

    .login-logo {
      width: 88px;
      height: 88px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 32px;
      box-shadow: 0 16px 32px rgba(16, 185, 129, 0.3);
      transform: rotate(-5deg);
      transition: transform 0.3s;
    }

    .login-content:hover .login-logo {
      transform: rotate(0deg) scale(1.05);
    }

    .login-title {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -1px;
    }

    body.light-mode .login-title {
      background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .login-desc {
      color: var(--text-secondary);
      margin-bottom: 40px;
      font-size: 15px;
      line-height: 1.6;
    }

    .btn-google {
      width: 100%;
      background: white;
      color: #1f2937;
      border: none;
      padding: 14px;
      border-radius: 16px;
      font-weight: 600;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .btn-google::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.05);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .btn-google:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .btn-google:hover::after {
      opacity: 1;
    }

    .btn-google:active {
      transform: scale(0.97);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes popIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body data-theme="slate">

  <!-- LOGIN SCREEN (Initial State: Visible) -->
  <div class="login-screen" id="loginScreen">
    <div class="login-bg-blob blob-1"></div>
    <div class="login-bg-blob blob-2"></div>
    <div class="login-content">
      <div class="login-logo">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
          <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 01-8 0"></path>
        </svg>
      </div>
      <h1 class="login-title">Lista de Compras</h1>
      <p class="login-desc">Sua lista inteligente, sincronizada e bonita. Entre para come√ßar.</p>

      <button class="btn-google" onclick="handleUserAction()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="none">
          <path
            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
            fill="#4285F4" />
          <path
            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
            fill="#34A853" />
          <path
            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
            fill="#FBBC05" />
          <path
            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
            fill="#EA4335" />
        </svg>
        Entrar com Google
      </button>
    </div>
  </div>

  <header class="app-header glass">
    <div class="header-title-group">
      <div class="header-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 01-8 0"></path>
        </svg>
      </div>
      <div class="app-title">Lista de Compras</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="user-btn" id="userBtn" onclick="handleUserAction()" style="position:relative">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          class="user-icon-default">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <div class="user-status"></div>
      </div>
      <button class="action-btn" onclick="toggleMode()" id="modeToggleBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          class="sun-icon">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          class="moon-icon" style="display:none">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
      <button class="action-btn" onclick="toggleSettings()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path
            d="M12 2.69l5.74 5.88-.69.58A5.5 5.5 0 0019 14.5c0 3.03-2.47 5.5-5.5 5.5S8 14.5 9.17 9.17l-.69-.58L12 2.69zM12 .5l-7 7.15A7.5 7.5 0 0013.5 19.85a7.5 7.5 0 005.5-12.2L12 .5z">
          </path>
        </svg>
      </button>
    </div>
  </header>

  <main class="content-area" id="listContainer">
    <!-- Content injected by JS -->
  </main>

  <div class="budget-chip" id="budgetTotal" style="display:none">R$ 0,00</div>

  <div class="bottom-bar">
    <div class="input-group">
      <button class="action-btn" onclick="backToLists()" id="backBtn" style="display:none">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
      </button>
      <input type="text" class="smart-input" id="mainInput" placeholder="Adicionar item (ex: Leite 2un 5,00)"
        autocomplete="off">
      <button class="add-btn" onclick="handleSmartAdd()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
    </div>
  </div>

  <!-- Theme Drawer -->
  <div class="drawer-overlay" id="drawerOverlay" onclick="toggleSettings()"></div>
  <div class="theme-drawer" id="themeDrawer">
    <h3 style="margin-bottom:12px;font-size:16px;">Escolha um Tema</h3>
    <div class="theme-grid" id="themeGrid"></div>
  </div>

  <script>
    // --- DATA & STATE ---
    const firebaseConfig = {
      apiKey: "AIzaSyD4euCkvc0ifpu3ZzAgzyD6eROnqOfY3MM",
      authDomain: "compras-37b98.firebaseapp.com",
      projectId: "compras-37b98",
      storageBucket: "compras-37b98.firebasestorage.app",
      messagingSenderId: "229833548671",
      appId: "1:229833548671:web:2db47b34bda12a6ee7704a",
      measurementId: "G-F8CKZZVZ25"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    const THEMES = [
      { id: 'slate', c: '#1E293B' }, { id: 'ocean', c: '#1e3a8a' }, { id: 'forest', c: '#14532d' },
      { id: 'burgundy', c: '#7f1d1d' }, { id: 'purple', c: '#581c87' }, { id: 'gold', c: '#713f12' },
      { id: 'pink', c: '#be185d' }, { id: 'charcoal', c: '#27272a' }, { id: 'sunset', c: '#9f1239' },
      { id: 'navy', c: '#172554' }
    ];

    const CATEGORIES = {
      'hortifruti': { icon: 'üçé', keys: ['ma√ß√£', 'banana', 'uva', 'batata', 'cebola', 'tomate', 'fruta', 'verdura'] },
      'padaria': { icon: 'üçû', keys: ['p√£o', 'bolo', 'torrada', 'farinha'] },
      'carnes': { icon: 'ü•©', keys: ['carne', 'frango', 'peixe', 'linguica', 'ovo'] },
      'laticinios': { icon: 'üßÄ', keys: ['leite', 'queijo', 'iogurte', 'manteiga'] },
      'limpeza': { icon: 'üßπ', keys: ['sab√£o', 'detergente', 'vassoura', 'papel', 'bucha'] },
      'bebidas': { icon: 'ü•§', keys: ['suco', 'refrigerante', 'cerveja', 'agua', 'vinho'] },
      'outros': { icon: 'üì¶', keys: [] }
    };

    let appState = {
      user: null,
      rawLists: [],
      rawItems: [],
      lists: [], // Computed for UI
      activeListId: null,
      theme: localStorage.getItem('sl-theme-v2') || 'slate',
      mode: localStorage.getItem('sl-mode-v1') || 'dark',
      unsubscribeLists: null,
      unsubscribeItems: null
    };
    async function checkAndMigrate(user) {
      const oldRef = db.collection('users').doc(user.uid).collection('shopping').doc('data');
      const doc = await oldRef.get();
      if (doc.exists) {
        const data = doc.data();
        if (data.lists && data.lists.length > 0) {
          console.log("Migrating data...");
          const batch = db.batch();

          // Migrate Lists & Items
          data.lists.forEach(list => {
            const listRef = db.collection('users').doc(user.uid).collection('lists').doc(list.id);
            batch.set(listRef, {
              name: list.name,
              created: list.created || Date.now()
            });

            if (list.items) {
              list.items.forEach(item => {
                const itemRef = db.collection('users').doc(user.uid).collection('items').doc(item.id || Date.now().toString());
                batch.set(itemRef, {
                  name: item.name,
                  qty: item.qty || 1,
                  price: item.price || 0,
                  cat: item.cat || 'outros',
                  checked: item.checked || false,
                  listId: list.id,
                  created: Date.now()
                });
              });
            }
          });

          // Migrate Theme
          if (data.theme || data.mode) {
            batch.set(db.collection('users').doc(user.uid), {
              theme: data.theme || 'slate',
              mode: data.mode || 'dark'
            }, { merge: true });
          }

          // Delete old doc
          batch.delete(oldRef);

          await batch.commit();
          console.log("Migration complete.");
        }
      }
    }

    // --- STATE MANAGEMENT ---
    function recalcLists() {
      // Combine rawLists and rawItems into the structure UI expects
      appState.lists = appState.rawLists.map(list => {
        const items = appState.rawItems.filter(i => i.listId === list.id);
        return { ...list, items: items };
      });
      updateUI();
    }

    function handleUserAction() {
      if (appState.user) {
        if (confirm(`Sair da conta de ${appState.user.displayName}?`)) {
          auth.signOut();
        }
      } else {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(e => alert("Erro ao entrar: " + e.message));
      }
    }

    function updateUserUI() {
      const btn = document.getElementById('userBtn');
      if (appState.user) {
        btn.classList.add('online');
        btn.innerHTML = `<img src="${appState.user.photoURL}" alt="User"><div class="user-status"></div>`;
      } else {
        btn.classList.remove('online');
        btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><div class="user-status"></div>`;
      }
    }

    // --- CORE UI ---
    function updateUI() {
      document.body.setAttribute('data-theme', appState.theme);
      const isLight = appState.mode === 'light';
      document.body.classList.toggle('light-mode', isLight);

      // Icons
      const sun = document.querySelector('.sun-icon');
      const moon = document.querySelector('.moon-icon');
      if (sun && moon) {
        sun.style.display = isLight ? 'none' : 'block';
        moon.style.display = isLight ? 'block' : 'none';
      }

      const container = document.getElementById('listContainer');
      const totalChip = document.getElementById('budgetTotal');
      const backBtn = document.getElementById('backBtn');
      const mainInput = document.getElementById('mainInput');

      if (appState.activeListId) {
        // Render Active List
        const list = appState.lists.find(l => l.id === appState.activeListId);
        if (!list) { appState.activeListId = null; updateUI(); return; }

        backBtn.style.display = 'flex';
        mainInput.placeholder = `Adicionar em "${list.name}"...`;

        let total = 0;
        let html = `<div style="margin-bottom:16px;">
      <h2 style="font-size:24px;font-weight:700;margin-bottom:4px">${list.name}</h2>
      <p style="opacity:0.6;font-size:13px">${list.items.filter(i => i.checked).length}/${list.items.length} itens comprados</p>
    </div>`;

        const sorted = [...list.items].sort((a, b) => a.checked - b.checked);

        if (sorted.length === 0) {
          html += `<div style="text-align:center;padding:40px;opacity:0.3">
        <div style="font-size:40px;margin-bottom:10px">üìù</div>
        <p>Lista vazia. Adicione itens abaixo!</p>
      </div>`;
        }

        sorted.forEach(item => {
          total += (item.price || 0) * (item.qty || 1);
          const cat = CATEGORIES[item.cat] || CATEGORIES['outros'];
          html += `
      <div class="item-row glass ${item.checked ? 'checked' : ''}">
        <div class="item-check" onclick="toggleItem('${item.id}')">
          ${item.checked ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="4"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
        </div>
        <div class="item-content" onclick="toggleItem('${item.id}')">
          <div class="item-name">${item.name} ${item.qty > 1 ? `<span style="opacity:0.6;font-size:13px">x${item.qty}</span>` : ''}</div>
          <div class="item-details">
            <span class="category-tag">${cat.icon} ${item.cat}</span>
            ${item.price > 0 ? `<span class="price-tag">R$ ${(item.price * (item.qty || 1)).toFixed(2)}</span>` : ''}
          </div>
        </div>
        <div class="item-actions">
           <button class="action-btn del" onclick="event.stopPropagation(); deleteItem('${item.id}')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>
        </div>
      </div>`;
        });

        container.innerHTML = html;

        if (total > 0) {
          totalChip.style.display = 'block';
          totalChip.textContent = `Total: R$ ${total.toFixed(2)}`;
        } else {
          totalChip.style.display = 'none';
        }

      } else {
        // Render Lists Index
        backBtn.style.display = 'none';
        mainInput.placeholder = "Criar nova lista...";
        totalChip.style.display = 'none';

        if (appState.lists.length === 0) {
          container.innerHTML = `<div style="text-align:center;padding:60px 20px;opacity:0.4">
        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:16px"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 01-8 0"></path></svg>
        <p>Nenhuma lista criada.</p>
        <p style="font-size:13px;margin-top:8px">Digite um nome abaixo para come√ßar.</p>
      </div>`;
          return;
        }

        let html = '';
        appState.lists.forEach(list => {
          const checked = list.items.filter(i => i.checked).length;
          const total = list.items.length;
          const percent = total === 0 ? 0 : (checked / total) * 100;

          html += `
      <div class="list-card glass" onclick="openList('${list.id}')">
        <div class="list-header">
          <input class="list-name" value="${list.name}" onclick="event.stopPropagation()" onchange="renameList('${list.id}', this.value)">
          <button class="action-btn del" onclick="event.stopPropagation(); deleteList('${list.id}')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>
        </div>
        <div class="list-meta">
          <span>${total} itens</span>
          <span>${checked} comprados</span>
        </div>
        <div class="progress-mini">
          <div class="progress-bar-mini" style="width:${percent}%"></div>
        </div>
      </div>`;
        });
        container.innerHTML = html;
      }
    }

    // --- FIREBASE AUTH ---
    auth.onAuthStateChanged(user => {
      appState.user = user;
      updateUserUI();

      const loginScreen = document.getElementById('loginScreen');

      if (user) {
        // Logged In
        if (loginScreen) loginScreen.classList.add('hidden');

        // Reset State for security
        appState.rawLists = [];
        appState.rawItems = [];
        appState.lists = [];

        // Migration Check
        checkAndMigrate(user);

        // Listeners
        if (appState.unsubscribeLists) appState.unsubscribeLists();
        if (appState.unsubscribeItems) appState.unsubscribeItems();

        appState.unsubscribeLists = db.collection('users').doc(user.uid).collection('lists')
          .orderBy('created', 'desc')
          .onSnapshot(snap => {
            appState.rawLists = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            recalcLists();
          });

        appState.unsubscribeItems = db.collection('users').doc(user.uid).collection('items')
          .onSnapshot(snap => {
            appState.rawItems = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            recalcLists();
          });

        // Load Theme Preference if exists
        db.collection('users').doc(user.uid).get().then(doc => {
          if (doc.exists) {
            const d = doc.data();
            if (d.theme) appState.theme = d.theme;
            if (d.mode) appState.mode = d.mode;
            updateUI();
          }
        });

      } else {
        // Logged Out
        if (loginScreen) loginScreen.classList.remove('hidden');

        if (appState.unsubscribeLists) appState.unsubscribeLists();
        if (appState.unsubscribeItems) appState.unsubscribeItems();

        // Clear Sensitive Data
        appState.rawLists = [];
        appState.rawItems = [];
        appState.activeListId = null;

        // Local Fallback (readonly or guest)
        const localLists = JSON.parse(localStorage.getItem('sl-lists-v2') || '[]');
        appState.lists = localLists;
        updateUI();
      }
    });
    // --- ACTIONS ---
    function handleSmartAdd() {
      const input = document.getElementById('mainInput');
      const val = input.value.trim();
      if (!val) return;

      if (appState.activeListId) {
        addItem(val);
      } else {
        createList(val);
      }
      input.value = '';
    }

    function createList(name) {
      if (!appState.user) return alert("Fa√ßa login para criar listas.");

      db.collection('users').doc(appState.user.uid).collection('lists').add({
        name: name,
        created: Date.now()
      }).then(docRef => {
        appState.activeListId = docRef.id;
        updateUI();
      });
    }

    function openList(id) {
      appState.activeListId = id;
      updateUI();
    }

    function backToLists() {
      appState.activeListId = null;
      updateUI();
    }

    function deleteList(id) {
      if (!appState.user) return;
      if (confirm('Excluir esta lista e todos os itens?')) {
        const batch = db.batch();
        // Delete list doc
        batch.delete(db.collection('users').doc(appState.user.uid).collection('lists').doc(id));

        // Delete items linked to list
        // Note: Client-side batch limit is 500. Assuming list < 500 items.
        // For production, this should be done via Cloud Functions or recursive delete tool.
        const itemsToDelete = appState.rawItems.filter(i => i.listId === id);
        itemsToDelete.forEach(item => {
          batch.delete(db.collection('users').doc(appState.user.uid).collection('items').doc(item.id));
        });

        batch.commit();
        if (appState.activeListId === id) appState.activeListId = null;
      }
    }

    function renameList(id, newName) {
      if (!appState.user) return;
      db.collection('users').doc(appState.user.uid).collection('lists').doc(id).update({ name: newName });
    }

    function addItem(text) {
      if (!appState.user) return;
      if (!appState.activeListId) return;

      // Smart Parse
      let name = text;
      let qty = 1;
      let price = 0;

      const priceMatch = text.match(/(\d+[,.]\d{2})/);
      if (priceMatch) {
        price = parseFloat(priceMatch[0].replace(',', '.'));
        name = name.replace(priceMatch[0], '').trim();
      }

      const qtyMatch = text.match(/(\d+)\s*(un|x|cx|kg)/i);
      if (qtyMatch) {
        qty = parseInt(qtyMatch[1]);
        name = name.replace(qtyMatch[0], '').trim();
      } else {
        const startNum = text.match(/^(\d+)\s+/);
        if (startNum) {
          qty = parseInt(startNum[1]);
          name = name.replace(startNum[0], '').trim();
        }
      }

      // Detect Category
      let cat = 'outros';
      const lower = name.toLowerCase();
      for (const [key, data] of Object.entries(CATEGORIES)) {
        if (data.keys.some(k => lower.includes(k))) {
          cat = key;
          break;
        }
      }

      db.collection('users').doc(appState.user.uid).collection('items').add({
        name: name,
        qty: qty,
        price: price,
        cat: cat,
        checked: false,
        listId: appState.activeListId,
        created: Date.now()
      });
    }

    function toggleItem(itemId) {
      if (!appState.user) return;
      const item = appState.rawItems.find(i => i.id === itemId);
      if (item) {
        db.collection('users').doc(appState.user.uid).collection('items').doc(itemId).update({ checked: !item.checked });
      }
    }

    function deleteItem(itemId) {
      if (!appState.user) return;
      if (confirm('Tem certeza que deseja excluir este item?')) {
        db.collection('users').doc(appState.user.uid).collection('items').doc(itemId).delete();
      }
    }

    // --- THEME ---
    function toggleSettings() {
      const drawer = document.getElementById('themeDrawer');
      const overlay = document.getElementById('drawerOverlay');
      drawer.classList.toggle('active');
      overlay.classList.toggle('active');
      renderThemeGrid();
    }

    function toggleMode() {
      appState.mode = appState.mode === 'light' ? 'dark' : 'light';
      if (appState.user) {
        db.collection('users').doc(appState.user.uid).set({ mode: appState.mode }, { merge: true });
      } else {
        localStorage.setItem('sl-mode-v1', appState.mode);
      }
      updateUI();
    }

    function renderThemeGrid() {
      const grid = document.getElementById('themeGrid');
      grid.innerHTML = THEMES.map(t => `
    <div class="theme-opt ${appState.theme === t.id ? 'active' : ''}" 
         style="background:${t.c}" 
         onclick="setTheme('${t.id}')">
    </div>
  `).join('');
    }

    function setTheme(id) {
      appState.theme = id;
      if (appState.user) {
        db.collection('users').doc(appState.user.uid).set({ theme: appState.theme }, { merge: true });
      } else {
        localStorage.setItem('sl-theme-v2', appState.theme);
      }
      toggleSettings(); // Close drawer
      updateUI();
    }

    // Input Enter Handler
    document.getElementById('mainInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handleSmartAdd();
    });

    // Init
    updateUI();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, (err) => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
</body>

</html>