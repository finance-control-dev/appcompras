<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Lista de Compras Premium</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <style>
    /* --- RESET & BASE --- */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent
    }

    :root {
      --font: 'Inter', sans-serif;
      --safe-bottom: env(safe-area-inset-bottom, 20px);

      /* Default Dark Mode Colors */
      --text-primary: #F8FAFC;
      --text-secondary: rgba(255, 255, 255, 0.6);
      --glass-bg: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.08);
      --input-bg: rgba(30, 41, 59, 0.8);
      --item-bg: rgba(255, 255, 255, 0.02);
      --drawer-bg: #1E293B;
      --icon-highlight: rgba(255, 255, 255, 0.1);
    }

    /* Light Mode Overrides */
    body.light-mode {
      background: var(--bg-grad-light);
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --glass-bg: rgba(255, 255, 255, 0.65);
      --glass-border: rgba(255, 255, 255, 0.4);
      --input-bg: rgba(255, 255, 255, 0.9);
      --item-bg: rgba(255, 255, 255, 0.5);
      --drawer-bg: #ffffff;
      --icon-highlight: rgba(0, 0, 0, 0.05);
      color: var(--text-primary);
    }

    /* --- THEMES (CSS Variables) --- */
    /* Default: Midnight Slate */
    [data-theme="slate"] {
      --bg-grad: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
      --bg-grad-light: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      --accent: #F97316;
      --accent-glow: rgba(249, 115, 22, 0.4);
    }

    [data-theme="ocean"] {
      --bg-grad: linear-gradient(135deg, #0f1c3f 0%, #1e3a8a 100%);
      --bg-grad-light: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      --accent: #38bdf8;
      --accent-glow: rgba(56, 189, 248, 0.4);
    }

    [data-theme="forest"] {
      --bg-grad: linear-gradient(135deg, #052e16 0%, #14532d 100%);
      --bg-grad-light: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      --accent: #4ade80;
      --accent-glow: rgba(74, 222, 128, 0.4);
    }

    [data-theme="burgundy"] {
      --bg-grad: linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%);
      --bg-grad-light: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
      --accent: #fb7185;
      --accent-glow: rgba(251, 113, 133, 0.4);
    }

    [data-theme="purple"] {
      --bg-grad: linear-gradient(135deg, #2e1065 0%, #581c87 100%);
      --bg-grad-light: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
      --accent: #c084fc;
      --accent-glow: rgba(192, 132, 252, 0.4);
    }

    [data-theme="gold"] {
      --bg-grad: linear-gradient(135deg, #272005 0%, #422006 100%);
      --bg-grad-light: linear-gradient(135deg, #fef9c3 0%, #fde047 100%);
      --accent: #fbbf24;
      --accent-glow: rgba(251, 191, 36, 0.4);
    }

    [data-theme="pink"] {
      --bg-grad: linear-gradient(135deg, #831843 0%, #be185d 100%);
      --bg-grad-light: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
      --accent: #f472b6;
      --accent-glow: rgba(244, 114, 182, 0.4);
    }

    [data-theme="charcoal"] {
      --bg-grad: linear-gradient(135deg, #18181b 0%, #27272a 100%);
      --bg-grad-light: linear-gradient(135deg, #f4f4f5 0%, #e4e4e7 100%);
      --accent: #9ca3af;
      --accent-glow: rgba(156, 163, 175, 0.4);
    }

    [data-theme="sunset"] {
      --bg-grad: linear-gradient(135deg, #4c0519 0%, #9f1239 100%);
      --bg-grad-light: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);
      --accent: #fb923c;
      --accent-glow: rgba(251, 146, 60, 0.4);
    }

    [data-theme="navy"] {
      --bg-grad: linear-gradient(135deg, #172554 0%, #1e3a8a 100%);
      --bg-grad-light: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      --accent: #60a5fa;
      --accent-glow: rgba(96, 165, 250, 0.4);
    }

    body {
      font-family: var(--font);
      background: var(--bg-grad);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      /* App-like feel */
      transition: background 0.5s ease;
    }

    /* --- GLASSMORPHISM UTILITIES --- */
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .glass-panel {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* --- LAYOUT --- */
    .app-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }

    .header-title-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #FFD700, #F97316);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      font-size: 20px;
    }

    .app-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 140px;
      /* Space for input bar */
    }

    /* --- LISTS --- */
    .list-card {
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      transition: transform 0.2s, background 0.2s;
      position: relative;
      overflow: hidden;
    }

    .list-card:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.07);
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .list-name {
      font-weight: 600;
      font-size: 16px;
      width: 100%;
      outline: none;
      background: transparent;
      border: none;
      color: var(--text-primary);
    }

    .list-meta {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      gap: 10px;
    }

    .progress-mini {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }

    .progress-bar-mini {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.5s;
    }

    /* --- ITEMS --- */
    .item-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      background: var(--item-bg);
      border: 1px solid var(--glass-border);
      transition: all 0.2s;
      animation: slideIn 0.3s ease;
    }

    .item-check {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      cursor: pointer;
    }

    .item-row.checked .item-check {
      background: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 0 10px var(--accent-glow);
    }

    .item-row.checked .item-content {
      opacity: 0.5;
      text-decoration: line-through;
    }

    .item-content {
      flex: 1;
      min-width: 0;
    }

    .item-name {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .item-details {
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      gap: 6px;
    }

    .category-tag {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .price-tag {
      color: var(--accent);
      font-weight: 600;
    }

    .item-actions {
      display: flex;
      gap: 8px;
      /* opacity: 0; removed for mobile/better UX */
      /* transition: opacity 0.2s; */
    }

    /*
    .item-row:hover .item-actions {
      opacity: 1;
    }
    */

    .action-btn {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: var(--icon-highlight);
      border: none;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      /* Prevent shrinking on mobile */
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .action-btn.del {
      background: rgba(239, 68, 68, 0.1);
      /* Subtle red background */
      color: #ef4444;
      /* Explicit red text */
    }

    .action-btn.del:hover {
      background: #ef4444;
      color: white;
    }

    body.light-mode .action-btn.del {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    body.light-mode .action-btn.del:hover {
      background: #dc2626;
      color: white;
    }

    /* --- BOTTOM BAR --- */
    .bottom-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px;
      padding-bottom: max(16px, var(--safe-bottom));
      z-index: 20;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--input-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      padding: 8px;
      border-radius: 24px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .smart-input {
      flex: 1;
      width: 0;
      /* Fix flex overflow */
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 16px;
      padding: 0 12px;
      height: 44px;
    }

    .add-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--accent);
      color: #0F172A;
      border: none;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px var(--accent-glow);
      transition: transform 0.2s;
      cursor: pointer;
      flex-shrink: 0;
      /* Prevent shrinking on mobile */
    }

    .add-btn:active {
      transform: scale(0.9);
    }

    /* --- THEME DRAWER --- */
    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 40;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .drawer-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .theme-drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--drawer-bg);
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      padding: 24px;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 50;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .theme-drawer.active {
      transform: translateY(0);
    }

    .theme-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .theme-opt {
      aspect-ratio: 1;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .theme-opt.active {
      border-color: white;
      transform: scale(1.1);
    }

    /* --- TOTALS --- */
    .budget-chip {
      position: absolute;
      bottom: 80px;
      right: 20px;
      background: var(--accent);
      color: #0F172A;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 4px 12px var(--accent-glow);
      pointer-events: none;
      animation: popIn 0.3s;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes popIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body data-theme="slate">

  <header class="app-header glass">
    <div class="header-title-group">
      <div class="header-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 01-8 0"></path>
        </svg>
      </div>
      <div class="app-title">Lista de Compras</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="action-btn" onclick="toggleMode()" id="modeToggleBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          class="sun-icon">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          class="moon-icon" style="display:none">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
      <button class="action-btn" onclick="toggleSettings()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path
            d="M12 2.69l5.74 5.88-.69.58A5.5 5.5 0 0019 14.5c0 3.03-2.47 5.5-5.5 5.5S8 14.5 9.17 9.17l-.69-.58L12 2.69zM12 .5l-7 7.15A7.5 7.5 0 0013.5 19.85a7.5 7.5 0 005.5-12.2L12 .5z">
          </path>
        </svg>
      </button>
    </div>
  </header>

  <main class="content-area" id="listContainer">
    <!-- Content injected by JS -->
  </main>

  <div class="budget-chip" id="budgetTotal" style="display:none">R$ 0,00</div>

  <div class="bottom-bar">
    <div class="input-group">
      <button class="action-btn" onclick="backToLists()" id="backBtn" style="display:none">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
      </button>
      <input type="text" class="smart-input" id="mainInput" placeholder="Adicionar item (ex: Leite 2un 5,00)"
        autocomplete="off">
      <button class="add-btn" onclick="handleSmartAdd()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
    </div>
  </div>

  <!-- Theme Drawer -->
  <div class="drawer-overlay" id="drawerOverlay" onclick="toggleSettings()"></div>
  <div class="theme-drawer" id="themeDrawer">
    <h3 style="margin-bottom:12px;font-size:16px;">Escolha um Tema</h3>
    <div class="theme-grid" id="themeGrid"></div>
  </div>

  <script>
    // --- DATA & STATE ---
    const THEMES = [
      { id: 'slate', c: '#1E293B' }, { id: 'ocean', c: '#1e3a8a' }, { id: 'forest', c: '#14532d' },
      { id: 'burgundy', c: '#7f1d1d' }, { id: 'purple', c: '#581c87' }, { id: 'gold', c: '#713f12' },
      { id: 'pink', c: '#be185d' }, { id: 'charcoal', c: '#27272a' }, { id: 'sunset', c: '#9f1239' },
      { id: 'navy', c: '#172554' }
    ];

    const CATEGORIES = {
      'hortifruti': { icon: 'üçé', keys: ['ma√ß√£', 'banana', 'uva', 'batata', 'cebola', 'tomate', 'fruta', 'verdura'] },
      'padaria': { icon: 'üçû', keys: ['p√£o', 'bolo', 'torrada', 'farinha'] },
      'carnes': { icon: 'ü•©', keys: ['carne', 'frango', 'peixe', 'linguica', 'ovo'] },
      'laticinios': { icon: 'üßÄ', keys: ['leite', 'queijo', 'iogurte', 'manteiga'] },
      'limpeza': { icon: 'üßπ', keys: ['sab√£o', 'detergente', 'vassoura', 'papel', 'bucha'] },
      'bebidas': { icon: 'ü•§', keys: ['suco', 'refrigerante', 'cerveja', 'agua', 'vinho'] },
      'outros': { icon: 'üì¶', keys: [] }
    };

    let appState = {
      lists: JSON.parse(localStorage.getItem('sl-lists-v2') || '[]'),
      activeListId: null,
      theme: localStorage.getItem('sl-theme-v2') || 'slate',
      mode: localStorage.getItem('sl-mode-v1') || 'dark'
    };

    // --- MIGRATION (V1 -> V2) ---
    if (!localStorage.getItem('sl-lists-v2') && localStorage.getItem('sl-lists')) {
      try {
        const old = JSON.parse(localStorage.getItem('sl-lists'));
        appState.lists = old.map(l => ({
          id: l.id,
          name: l.name,
          items: (l.items || []).map(i => ({ id: i.id, name: i.name, checked: i.checked, cat: 'outros', price: 0, qty: 1 })),
          created: Date.now()
        }));
        save();
      } catch (e) { }
    }

    // --- CORE FUNCTIONS ---
    function save() {
      localStorage.setItem('sl-lists-v2', JSON.stringify(appState.lists));
      localStorage.setItem('sl-theme-v2', appState.theme);
      localStorage.setItem('sl-mode-v1', appState.mode);
      updateUI();
    }

    function updateUI() {
      document.body.setAttribute('data-theme', appState.theme);

      // Handle Mode
      const isLight = appState.mode === 'light';
      document.body.classList.toggle('light-mode', isLight);

      // Toggle Icons
      const sun = document.querySelector('.sun-icon');
      const moon = document.querySelector('.moon-icon');
      if (sun && moon) {
        sun.style.display = isLight ? 'none' : 'block';
        moon.style.display = isLight ? 'block' : 'none';
      }

      const container = document.getElementById('listContainer');
      const totalChip = document.getElementById('budgetTotal');
      const backBtn = document.getElementById('backBtn');
      const mainInput = document.getElementById('mainInput');

      if (appState.activeListId) {
        // Render Items
        const list = appState.lists.find(l => l.id === appState.activeListId);
        if (!list) { appState.activeListId = null; updateUI(); return; }

        backBtn.style.display = 'flex';
        mainInput.placeholder = `Adicionar em "${list.name}"...`;

        let total = 0;
        let html = `<div style="margin-bottom:16px;">
      <h2 style="font-size:24px;font-weight:700;margin-bottom:4px">${list.name}</h2>
      <p style="opacity:0.6;font-size:13px">${list.items.filter(i => i.checked).length}/${list.items.length} itens comprados</p>
    </div>`;

        // Sort: unchecked first
        const sorted = [...list.items].sort((a, b) => a.checked - b.checked);

        if (sorted.length === 0) {
          html += `<div style="text-align:center;padding:40px;opacity:0.3">
        <div style="font-size:40px;margin-bottom:10px">üìù</div>
        <p>Lista vazia. Adicione itens abaixo!</p>
      </div>`;
        }

        sorted.forEach(item => {
          total += (item.price || 0) * (item.qty || 1);
          const cat = CATEGORIES[item.cat] || CATEGORIES['outros'];
          html += `
      <div class="item-row glass ${item.checked ? 'checked' : ''}">
        <div class="item-check" onclick="toggleItem('${item.id}')">
          ${item.checked ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="4"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
        </div>
        <div class="item-content">
          <div class="item-name">${item.name} ${item.qty > 1 ? `<span style="opacity:0.6;font-size:13px">x${item.qty}</span>` : ''}</div>
          <div class="item-details">
            <span class="category-tag">${cat.icon} ${item.cat}</span>
            ${item.price > 0 ? `<span class="price-tag">R$ ${(item.price * (item.qty || 1)).toFixed(2)}</span>` : ''}
          </div>
        </div>
        <div class="item-actions">
           <button class="action-btn del" onclick="deleteItem('${item.id}')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>
        </div>
      </div>`;
        });

        container.innerHTML = html;

        if (total > 0) {
          totalChip.style.display = 'block';
          totalChip.textContent = `Total: R$ ${total.toFixed(2)}`;
        } else {
          totalChip.style.display = 'none';
        }

      } else {
        // Render Lists
        backBtn.style.display = 'none';
        mainInput.placeholder = "Criar nova lista...";
        totalChip.style.display = 'none';

        if (appState.lists.length === 0) {
          container.innerHTML = `<div style="text-align:center;padding:60px 20px;opacity:0.4">
        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:16px"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 01-8 0"></path></svg>
        <p>Nenhuma lista criada.</p>
        <p style="font-size:13px;margin-top:8px">Digite um nome abaixo para come√ßar.</p>
      </div>`;
          return;
        }

        let html = '';
        appState.lists.forEach(list => {
          const checked = list.items.filter(i => i.checked).length;
          const total = list.items.length;
          const percent = total === 0 ? 0 : (checked / total) * 100;

          html += `
      <div class="list-card glass" onclick="openList('${list.id}')">
        <div class="list-header">
          <input class="list-name" value="${list.name}" onclick="event.stopPropagation()" onchange="renameList('${list.id}', this.value)">
          <button class="action-btn del" onclick="event.stopPropagation(); deleteList('${list.id}')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        </div>
        <div class="list-meta">
          <span>${total} itens</span>
          <span>${checked} comprados</span>
        </div>
        <div class="progress-mini">
          <div class="progress-bar-mini" style="width:${percent}%"></div>
        </div>
      </div>`;
        });
        container.innerHTML = html;
      }
    }

    // --- ACTIONS ---
    function handleSmartAdd() {
      const input = document.getElementById('mainInput');
      const val = input.value.trim();
      if (!val) return;

      if (appState.activeListId) {
        addItem(val);
      } else {
        createList(val);
      }
      input.value = '';
    }

    function createList(name) {
      const newList = {
        id: Date.now().toString(36),
        name: name,
        items: [],
        created: Date.now()
      };
      appState.lists.unshift(newList);
      appState.activeListId = newList.id;
      save();
    }

    function openList(id) {
      appState.activeListId = id;
      updateUI();
    }

    function backToLists() {
      appState.activeListId = null;
      updateUI();
    }

    function deleteList(id) {
      if (confirm('Excluir esta lista?')) {
        appState.lists = appState.lists.filter(l => l.id !== id);
        save();
      }
    }

    function renameList(id, newName) {
      const l = appState.lists.find(x => x.id === id);
      if (l) { l.name = newName; save(); }
    }

    function addItem(text) {
      const list = appState.lists.find(l => l.id === appState.activeListId);
      if (!list) return;

      // Smart Parse: "Leite 2un 10.00"
      let name = text;
      let qty = 1;
      let price = 0;

      // Extract Price (e.g., 5,99 or 5.99)
      const priceMatch = text.match(/(\d+[,.]\d{2})/);
      if (priceMatch) {
        price = parseFloat(priceMatch[0].replace(',', '.'));
        name = name.replace(priceMatch[0], '').trim();
      }

      // Extract Qty (e.g., 2un, 3x)
      const qtyMatch = text.match(/(\d+)\s*(un|x|cx|kg)/i);
      if (qtyMatch) {
        qty = parseInt(qtyMatch[1]);
        name = name.replace(qtyMatch[0], '').trim();
      } else {
        // Try finding standalone number at start
        const startNum = text.match(/^(\d+)\s+/);
        if (startNum) {
          qty = parseInt(startNum[1]);
          name = name.replace(startNum[0], '').trim();
        }
      }

      // Detect Category
      let cat = 'outros';
      const lower = name.toLowerCase();
      for (const [key, data] of Object.entries(CATEGORIES)) {
        if (data.keys.some(k => lower.includes(k))) {
          cat = key;
          break;
        }
      }

      list.items.push({
        id: Date.now().toString(36) + Math.random().toString(36).slice(2),
        name: name,
        qty: qty,
        price: price,
        cat: cat,
        checked: false
      });
      save();
    }

    function toggleItem(itemId) {
      const list = appState.lists.find(l => l.id === appState.activeListId);
      if (list) {
        const item = list.items.find(i => i.id === itemId);
        if (item) { item.checked = !item.checked; save(); }
      }
    }

    function deleteItem(itemId) {
      const list = appState.lists.find(l => l.id === appState.activeListId);
      if (list) {
        list.items = list.items.filter(i => i.id !== itemId);
        save();
      }
    }

    // --- THEME ---
    function toggleSettings() {
      const drawer = document.getElementById('themeDrawer');
      const overlay = document.getElementById('drawerOverlay');
      drawer.classList.toggle('active');
      overlay.classList.toggle('active');
      renderThemeGrid();
    }

    function toggleMode() {
      appState.mode = appState.mode === 'light' ? 'dark' : 'light';
      save();
    }

    function renderThemeGrid() {
      const grid = document.getElementById('themeGrid');
      grid.innerHTML = THEMES.map(t => `
    <div class="theme-opt ${appState.theme === t.id ? 'active' : ''}" 
         style="background:${t.c}" 
         onclick="setTheme('${t.id}')">
    </div>
  `).join('');
    }

    function setTheme(id) {
      appState.theme = id;
      save();
      toggleSettings(); // Close drawer
    }

    // Input Enter Handler
    document.getElementById('mainInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handleSmartAdd();
    });

    // Init
    updateUI();
  </script>
</body>

</html>
